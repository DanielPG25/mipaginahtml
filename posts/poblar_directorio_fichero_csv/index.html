<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="Daniel Parrales">
    <meta name="description" content="Poblar un directorio LDAP desde un fichero CSV">
    <meta name="keywords" content="blog,developer,personal,">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Poblar un directorio LDAP desde un fichero CSV"/>
<meta name="twitter:description" content="Poblar un directorio LDAP desde un fichero CSV"/>

    <meta property="og:title" content="Poblar un directorio LDAP desde un fichero CSV" />
<meta property="og:description" content="Poblar un directorio LDAP desde un fichero CSV" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sysadblog.onrender.com/posts/poblar_directorio_fichero_csv/" />
<meta property="article:published_time" content="2022-02-04T09:02:14+01:00" />
<meta property="article:modified_time" content="2022-02-04T09:02:14+01:00" />


    <title>
  Poblar un directorio LDAP desde un fichero CSV · Sysadblog
</title>

    
      <link rel="canonical" href="https://sysadblog.onrender.com/posts/poblar_directorio_fichero_csv/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.8e2b2510f60e1715eae08d113a808dcdaf17f6f711edb9e969be38d0074d240d.css" integrity="sha256-jislEPYOFxXq4I0ROoCNza8X9vcR7bnpab440AdNJA0=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css" integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.80.0" />
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-auto"
        onload=""
  >
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Sysadblog
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/aboutme">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/categories">Categories</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://sysadblog.onrender.com/posts/poblar_directorio_fichero_csv/">
              Poblar un directorio LDAP desde un fichero CSV
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2022-02-04T09:02:14&#43;01:00'>
                February 4, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              6-minute read
            </span>
          </div>
          <div class="authors">
    <i class="fa fa-user" aria-hidden="true"></i>
      <a href="/authors/daniel-parrales/">Daniel Parrales</a></div>
          <div class="categories">
  <i class="fa fa-folder" aria-hidden="true"></i>
    <a href="/categories/administraci%C3%B3n-de-sistemas-operativos/">Administración de Sistemas Operativos</a></div>

          
        </div>
      </header>

      <div>
        
        <h1 id="poblar-un-directorio-ldap-desde-un-fichero-csv">
  Poblar un directorio LDAP desde un fichero CSV
  <a class="heading-link" href="#poblar-un-directorio-ldap-desde-un-fichero-csv">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<ul>
<li>
<p>Crear entre todos los alumnos de la clase que vayan a hacer esta tarea un fichero CSV que incluya información personal de cada uno incluyendo los siguientes datos:</p>
<ul>
<li>
<p>Nombre</p>
</li>
<li>
<p>Apellidos</p>
</li>
<li>
<p>Dirección de correo electrónico</p>
</li>
<li>
<p>Nombre de usuario</p>
</li>
<li>
<p>Clave pública ssh</p>
</li>
</ul>
</li>
<li>
<p>Añadir el esquema openssh-lpk al directorio para poder incluir claves públicas ssh en un directorio LDAP.</p>
</li>
<li>
<p>Hacer un script en bash o en python que utilice el fichero como entrada y pueble el directorio LDAP con un objeto para cada alumno utilizando los ObjectClass posixAccount e inetOrgPerson.</p>
</li>
<li>
<p>Configurar el sistema para que sean válidos los usuarios del LDAP.</p>
</li>
<li>
<p>Configurar el servicio ssh para que permita acceder a los usuarios del LDAP utilizando las claves públicas que hay allí, en lugar de almacenarlas en <code>.ssh/authorized_keys</code> y que se cree el directorio &ldquo;home&rdquo; al vuelo.</p>
</li>
</ul>
<hr>
<p>Para empezar vamos a explicar un poco lo que es un fichero csv (Comma Separated Values). Tal y como su nombre indica, es un fichero que tiene información separada por comas (u otro delimitador si queremos). Lo importante en nuestro caso, es que cada usuario tendrá toda la información en una línea, y cada línea representará a un usuario. Quedaría de la siguiente forma:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nombre,apellidos,correo,usuario,clave_pública
</code></pre></div><p>Una vez explicado esto, procedemos a crear el fichero en cuestión:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano usuarios.csv

Daniel,Parrales Garcia,daniparrales16@gmail.com,dparrales,ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDBkhwPlBiJghsCe5xE4AQBQQIpq7lUrWgFeZATGkIQ0cmQWI55Qy5T3GSLiDjA0+lvw0eWpIYvKigtlBtQNxxFAON4rzL5vSpsm7IAiCRhpGBEXYbuCCVURmcapwd0ifRHt3ocxTfbqtebvA0CfT7GFBkryjS9B26uSJ43/BECxIB3boxkHUAXIHtVpQNXCavoZjm6S6EKGt/8bSWfPtgdFdCu62doN739Nk5RzdrTIw5CdqdUEGuwCMj8fWuePLZkLfmXx1ckwilf0n6U6gG2FV21/wS8BWqVeMcYpmOn6ZxlkDMnVJX+fl7kOLQoyZewrRwJy9P9MuyzXihtmJP89ERcC+kWFrP0/1YbXJ1XZQD1pRXjLJjDHj1th33DBDx77W5DoBAoJlAE7wqf50wCVSyiVEK91IhevSMmFbxOmhGPAh6BiYXx8QNo1sDLsvfQOEoCE5XRWJ+sn8coEULnY7igEbbaiQcVA8YpqM3PrxaBTAb4Gez+48nAP4sf3N8= dparrales@debian 
Lara,Pruna Ternero,larapruter@gmail.com,lpruna,ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDegOTxSBw35gaDyA+fvKieQ48uSqSGFfQMHRGLwVTt4DmGlBo9ACXtnuyGTbD9Vwk4FhTGwz53khdwfkqztIjD850oO644Y6FM2tcHFATeCjicgda7F4sE/LIqApgdUEvIAKogZlwIZpjrfwqAqztNtfsDQ21FOQk+VXMBM7ojK36hdc3pY3vWQvZ0kWoYw1kjgClPJ0NldedfwYWfiKVk+w675ugn/FacxmWXICY9i2RtN65gMlx1RgYmk2Bam3X+cYixUd4FvxozTh0edv5Ru5YviJbK564z+T+ev6KnS+swMw9FCG4SMoW4FKsQBvs/RjC6GFswp4Tl22/nTiqpo6gyFMjlyJnkXAFMDr2tgvhaHZZPsKflRuipK3owu/22cVJ9QVmriEUwWh9ooD7Hr2naiuOdiKj3c5eF1+3zPNkaxccXqHaQ1M8XrcTJQMSDWYqiCt7EKyrsiYDppKULO/lIuTTDMHMlZWV1+I5JNUcBAvakyumgvIXOvlD8SYM= lpruna@debian
</code></pre></div><p>Una vez que hayamos creado estos dos ficheros, tenemos que añadir el esquema openssh-lpk. Para ello crearemos el siguiente fichero ldif con la definición del esquema en <code>/etc/ldap/schema/</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano /etc/ldap/schema/openssh-lpk.ldif

dn: cn=openssh-lpk,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: openssh-lpk
olcAttributeTypes: ( 1.3.6.1.4.1.24552.500.1.1.1.13 NAME &#39;sshPublicKey&#39;
  DESC &#39;MANDATORY: OpenSSH Public key&#39;
  EQUALITY octetStringMatch
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )
olcObjectClasses: ( 1.3.6.1.4.1.24552.500.1.1.2.0 NAME &#39;ldapPublicKey&#39; SUP top AUXILIARY
  DESC &#39;MANDATORY: OpenSSH LPK objectclass&#39;
  MAY ( sshPublicKey $ uid )
  )
</code></pre></div><p>Y lo importamos con el siguiente comando:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">ldapadd -Y EXTERNAL -H ldapi:/// -f openssh-lpk.ldif
</code></pre></div><p>Pasemos ahora al script que añadirá los usuarios al directorio ldap a partir del fichero csv. He elegido realizar este script en python, usando un módulo de python llamado &ldquo;pyhton3-ldap&rdquo;. Como vamos a añadir un nuevo módulo al sistema, lo recomendable es que creemos un entorno virtual e instalar en dicho entorno el módulo (para que de esta forma no se produzcan problemas de versiones entre paquetes). Así pues, creamos el entorno virtual:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">apt install python3-venv

python3 -m venv ldap
</code></pre></div><p>Ahora instalamos el módulo correspondiente. Hay que decir que el módulo tiene algunos bugs si se utilizan determinadas versiones del mismo, por lo que he descargado e instalado una version que he comprobado que funciona:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">pip install python3-ldap

pip install ldap3==2.6
</code></pre></div><p>Ahora vayamos al script en cuestión:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano poblarusuarios.py 

#!/usr/bin/env python

import ldap3
from ldap3 import Connection, ALL
from getpass import getpass
from sys import exit

### VARIABLES

# Shell que se le asigna a los usuarios
shell = &#39;/bin/bash&#39;

# Ruta absoluta del directorio que contiene los directorios personales de los usuarios. Terminado en &#34;/&#34;
home_dir = &#39;/home/&#39;

# El valor inicial para los UID que se asignan al insertar usuarios. 
uid_number = 5000

# El GID que se le asigna a los usuarios. Si no se manda al anadir el usuario da error.
gid = 5000

### VARIABLES

# Leemos el fichero .csv de los usuarios y guardamos cada linea en una lista.
with open(&#39;usuarios.csv&#39;, &#39;r&#39;) as usuarios:
  usuarios = usuarios.readlines()


### Parametros para la conexion
ldap_ip = &#39;ldaps://apolo.dparrales.gonzalonazareno.org:636&#39;
dominio_base = &#39;dc=dparrales,dc=gonzalonazareno,dc=org&#39;
user_admin = &#39;admin&#39; 
contrasena = getpass(&#39;Contrasena: &#39;)

# Intenta realizar la conexion.
conn = Connection(ldap_ip, &#39;cn={},{}&#39;.format(user_admin, dominio_base),contrasena)

# conn.bind() devuelve &#34;True&#34; si se ha establecido la conexion y &#34;False&#34; en caso contrario.

# Si no se establece la conexion imprime por pantalla un error de conexion.
if not conn.bind():
  print(&#39;No se ha podido conectar con ldap&#39;) 
  if conn.result[&#39;description&#39;] == &#39;invalidCredentials&#39;:
    print(&#39;Credenciales no validas.&#39;)
  # Termina el script.
  exit(0)

# Recorre la lista de usuarios
for user in usuarios:
  # Separa los valores del usuario usando como delimitador &#34;,&#34;, y asigna cada valor a la variable correspondiente.
  user = user.split(&#39;,&#39;)
  cn = user[0]
  sn = user[1]
  mail = user[2]
  uid = user[3]
  ssh = user[4]

  #Anade el usuario.
  conn.add(
    &#39;uid={},ou=Personas,{}&#39;.format(uid, dominio_base),
    object_class = 
      [
      &#39;inetOrgPerson&#39;,
      &#39;posixAccount&#39;, 
      &#39;ldapPublicKey&#39;
      ],
    attributes =
      {
      &#39;cn&#39;: cn,
      &#39;sn&#39;: sn,
      &#39;mail&#39;: mail,
      &#39;uid&#39;: uid,
      &#39;uidNumber&#39;: str(uid_number),
      &#39;gidNumber&#39;: str(gid),
      &#39;homeDirectory&#39;: &#39;{}{}&#39;.format(home_dir,uid),
      &#39;loginShell&#39;: shell,
      &#39;sshPublicKey&#39;: str(ssh)
      })

  if conn.result[&#39;description&#39;] == &#39;entryAlreadyExists&#39;:
    print(&#39;El usuario {} ya existe.&#39;.format(uid))

  # Aumenta el contador para asignar un UID diferente a cada usuario (cada vez que ejecutemos el script debemos asegurarnos de ante mano que no existe dicho uid en el directorio ldap, o se solaparian los datos)
  uid_number += 1

#Cierra la conexion.
conn.unbind()
</code></pre></div><p>Y vemos si funciona con el archivo anterior:</p>
<p><img src="/images/poblar_directorio_fichero_csv/script.png" alt="script.png"></p>
<p>Comprobamos si se han añadido los usuarios indicados:</p>
<p><img src="/images/poblar_directorio_fichero_csv/resultado_script.png" alt="resultado_script.png"></p>
<h2 id="configurar-el-sistema-para-que-sean-válidos-los-usuarios-del-ldap">
  Configurar el sistema para que sean válidos los usuarios del LDAP.
  <a class="heading-link" href="#configurar-el-sistema-para-que-sean-v%c3%a1lidos-los-usuarios-del-ldap">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Para ello nos debemos ir al fichero <code>/etc/ldap/ldap.conf</code> del cliente y cambiar la siguiente información:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano /etc/ldap/ldap.conf

BASE dc=dparrales,dc=gonzalonazareno,dc=org
URI ldaps://127.0.0.1
</code></pre></div><p>También debemos modificar la configuración del nss (Name Service Switch) para que el sistema sea capaz de comprobar los UID y GID en el directorio ldap:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano /etc/nsswitch.conf

passwd:         files systemd ldap
group:          files systemd ldap
shadow:         files ldap
</code></pre></div><p>Para que esto funcione, debemos instalarnos el siguiente paquete y configurarlo de forma correcta:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">apt install libnss-ldap
</code></pre></div><p><img src="/images/poblar_directorio_fichero_csv/conf1.png" alt="conf1.png"></p>
<p><img src="/images/poblar_directorio_fichero_csv/conf2.png" alt="conf2.png"></p>
<p><img src="/images/poblar_directorio_fichero_csv/conf3.png" alt="conf3.png"></p>
<p><img src="/images/poblar_directorio_fichero_csv/conf4.png" alt="conf4.png"></p>
<p>A las ultimas dos cuestiones respondí que no, ya que me parecieron opcionales. Ahora ya podemos inciar sesión en nuestra máquina usando los usuarios que tenemos en el directorio ldap (usaré por ejemplo el usuario impmon que creé en otro ejercicio):</p>
<p><img src="/images/poblar_directorio_fichero_csv/acceso_usuario.png" alt="acceso_usuario.png"></p>
<h2 id="configurar-el-servicio-ssh-para-que-permita-acceder-a-los-usuarios-del-ldap-utilizando-las-claves-públicas-que-hay-allí-en-lugar-de-almacenarlas-en-sshauthorized_keys-y-que-se-cree-el-directorio-home-al-vuelo">
  Configurar el servicio ssh para que permita acceder a los usuarios del LDAP utilizando las claves públicas que hay allí, en lugar de almacenarlas en <code>.ssh/authorized_keys</code> y que se cree el directorio &ldquo;home&rdquo; al vuelo.
  <a class="heading-link" href="#configurar-el-servicio-ssh-para-que-permita-acceder-a-los-usuarios-del-ldap-utilizando-las-claves-p%c3%bablicas-que-hay-all%c3%ad-en-lugar-de-almacenarlas-en-sshauthorized_keys-y-que-se-cree-el-directorio-home-al-vuelo">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Para que al acceder con dichos usuarios se cree el directorio home del usuario, debemos ejecutar lo siguiente:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">echo &#34;session    required        pam_mkhomedir.so&#34; &gt;&gt; /etc/pam.d/common-session
</code></pre></div><p>Ahora volvemos a entrar con el usuario anterior y vemos si se ha creado su directorio home:</p>
<p><img src="/images/poblar_directorio_fichero_csv/crear_directorio.png" alt="crear_directorio.png"></p>
<p>Pasemos a configurar el sistema para que acepte el acceso por ssh a los usuarios que tengan sus claves públicas en el directorio de ldap.</p>
<p>Para empezar debemos crear un script que busque las claves públicas registradas al usuario indicado. Debido a algunos parámetros de seguridad de ssh, se nos requiere que el script en cuestión se encuentre en un directorio perteneciente a root y que el script tenga unos permisos concretos. Así pues, he decidido crear el script en /opt:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nano /opt/buscarclave.sh 

<span style="color:#75715e">#!/bin/bash</span>

ldapsearch -x -u -LLL -o ldif-wrap<span style="color:#f92672">=</span>no <span style="color:#e6db74">&#39;(&amp;(objectClass=posixAccount)(uid=&#39;</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;))&#39;</span> <span style="color:#e6db74">&#39;sshPublicKey&#39;</span> | sed -n <span style="color:#e6db74">&#39;s/^[ \t]*sshPublicKey::[ \t]*\(.*\)/\1/p&#39;</span> | base64 -d
</code></pre></div><p>Y cambiamos los permisos del script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">chmod 755 /opt/buscarclave.sh 
</code></pre></div><p>Podemos ver que el script encuentra las claves de forma adecuada:</p>
<p><img src="/images/poblar_directorio_fichero_csv/sacar_clave.png" alt="sacar_clave.png"></p>
<p>Ahora añadimos las siguientes líneas al fichero <code>/etc/ssh/sshd_config</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano /etc/ssh/sshd_config

AuthorizedKeysCommand /opt/buscarclave.sh
AuthorizedKeysCommandUser nobody
</code></pre></div><p>Y reiniciamos el servicio de ssh para aplicar los cambios:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">systemctl restart sshd
</code></pre></div><p>Comprobamos si podemos acceder por ssh usando los usuarios de ldap que tengan su clave en el directorio:</p>
<p><img src="/images/poblar_directorio_fichero_csv/acceso_usuario_ssh.png" alt="acceso_usuario_ssh.png"></p>
<p>Como vemos hemos podido acceder de forma adecuada usando dicho usuario.</p>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
        <p>El descenso hacia Debian profundo</p>
      
      
        ©
        
          2021 -
        
        2022
         Daniel Parrales 
      
      
         · 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>


    </main>

    
      
      <script src="/js/coder.min.a350362441276ec5c1671926420497bb8e52b63ead1d51d3c9bc4342d0039526.js" integrity="sha256-o1A2JEEnbsXBZxkmQgSXu45Stj6tHVHTybxDQtADlSY="></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
