<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="Daniel Parrales">
    <meta name="description" content="Ejercicios con el servidor de correo Postfix">
    <meta name="keywords" content="blog,developer,personal,">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ejercicios con Postfix"/>
<meta name="twitter:description" content="Ejercicios con el servidor de correo Postfix"/>

    <meta property="og:title" content="Ejercicios con Postfix" />
<meta property="og:description" content="Ejercicios con el servidor de correo Postfix" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sysadblog.onrender.com/posts/ejercicios_con_postfix/" />
<meta property="article:published_time" content="2022-01-19T08:50:08+01:00" />
<meta property="article:modified_time" content="2022-01-19T08:50:08+01:00" />


    <title>
  Ejercicios con Postfix · Sysadblog
</title>

    
      <link rel="canonical" href="https://sysadblog.onrender.com/posts/ejercicios_con_postfix/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.8e2b2510f60e1715eae08d113a808dcdaf17f6f711edb9e969be38d0074d240d.css" integrity="sha256-jislEPYOFxXq4I0ROoCNza8X9vcR7bnpab440AdNJA0=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.aa883b9ce35a8ff4a2a5008619005175e842bb18a8a9f9cc2bbcf44dab2d91fa.css" integrity="sha256-qog7nONaj/SipQCGGQBRdehCuxioqfnMK7z0Tastkfo=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.80.0" />
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-auto"
        onload=""
  >
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Sysadblog
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/aboutme">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/categories">Categories</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://sysadblog.onrender.com/posts/ejercicios_con_postfix/">
              Ejercicios con Postfix
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2022-01-19T08:50:08&#43;01:00'>
                January 19, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              5-minute read
            </span>
          </div>
          <div class="authors">
    <i class="fa fa-user" aria-hidden="true"></i>
      <a href="/authors/daniel-parrales/">Daniel Parrales</a></div>
          <div class="categories">
  <i class="fa fa-folder" aria-hidden="true"></i>
    <a href="/categories/servicios-de-red/">Servicios de Red</a></div>

          
        </div>
      </header>

      <div>
        
        <h1 id="ejercicios-con-el-servidor-de-correos-postfix">
  Ejercicios con el Servidor de Correos (Postfix)
  <a class="heading-link" href="#ejercicios-con-el-servidor-de-correos-postfix">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<h2 id="ejercicio-1-envío-local-entre-usuarios-del-mismo-servidor">
  Ejercicio 1: Envío local, entre usuarios del mismo servidor
  <a class="heading-link" href="#ejercicio-1-env%c3%ado-local-entre-usuarios-del-mismo-servidor">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Instala y configura un servidor de correo en apolo. El nombre del sistema de correo será tu nombre de dominio <code>tudominio.gonzalonazareno.org</code>.</p>
<p>Utilizando la utilidad mail manda un correo desde un usuario del servidor a otro usuario del servidor. El usuario destinatario debe leer el correo con el mismo programa.</p>
<hr>
<p>Para empezar, en apolo vamos a tener que instalar los dos paquetes que vamos a necesitar para este y los próximos ejercicios:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">apt install postfix bsd-mailx
</code></pre></div><p>Al instalar postfix nos saldrá el siguiente menú:</p>
<p><img src="/images/ejercicios_servidor_correos/img_1.png" alt="img_1.png"></p>
<p><img src="/images/ejercicios_servidor_correos/img_2.png" alt="img_2.png"></p>
<p>Seleccionamos &ldquo;Internet Site&rdquo;. A continuación nos aparece el siguiente menú:</p>
<p><img src="/images/ejercicios_servidor_correos/img_3.png" alt="img_3.png"></p>
<p>En este momento nos está preguntando por el nombre del dominio en el que estará en el servidor de correos, por lo que he puesto el dominio que he configurado en mi escenario: <code>dparrales.gonzalonazareno.org</code>. Con esto ya habríamos terminado de instalar postfix y podríamos empezar a mandar correos dentro del mismo servidor usando la herramienta <code>mail</code>.</p>
<p>Más adelante, en otros ejercicios, entraremos en más profundidad con la configuración de postfix, pero por ahora nos vale lo que hemos hecho para completar el ejercicio. Así pues, mandamos un correo a otro usuario del servidor usando la siguiente sintaxis:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">mail nombre_usuario@dominio
</code></pre></div><p><img src="/images/ejercicios_servidor_correos/img_4.png" alt="img_4.png"></p>
<p>Como vemos he mandado un correo al usuario impmon (creado para otras prácticas). Una vez terminado el cuerpo del mensaje salimos con Control+D.</p>
<p>Ahora entremos como dicho usuario y comprobemos si ha llegado el correo:</p>
<p><img src="/images/ejercicios_servidor_correos/img_5.png" alt="img_5.png"></p>
<p>Para ver el correo usamos el comando <code>mail</code> sin ningún parámetro. Podemos ver que el correo ha llegado, y tiene el número 1 asignado, por lo que para leer dicho correo simplemente introducimos dicho número:</p>
<p><img src="/images/ejercicios_servidor_correos/img_6.png" alt="img_6.png"></p>
<p>El correo ha llegado de forma satisfactoria, así que podemos dar por concluido este ejercicio.</p>
<h2 id="ejercicio-2-envío-de-correo-desde-usuarios-del-servidor-a-correos-de-internet">
  Ejercicio 2: Envío de correo desde usuarios del servidor a correos de Internet
  <a class="heading-link" href="#ejercicio-2-env%c3%ado-de-correo-desde-usuarios-del-servidor-a-correos-de-internet">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Configura tu servidor de correo para que use como relay el servidor de correo de nuestra red babuino-smtp. Con la utilidad mail envía un correo a tu cuenta personal de gmail, hotmail, etc.</p>
<p>Muestra el log del sistema donde se comprueba que el correo se ha enviado con éxito.</p>
<p>Comprueba las cabeceras del correo que has recibido e indica donde vemos los servidores por los que ha pasado el correo.</p>
<hr>
<p>En este ejercicio seguiremos usando las mismas máquinas que en el anterior. Así pues, para configurar a <code>babuino-smtp</code> como relay, debemos añadir la siguiente línea en el fichero de configuración de postfix (<code>/etc/postfix/main.cf</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano /etc/postfix/main.cf

relayhost = babuino-smtp.gonzalonazareno.org
</code></pre></div><p>Ahora probamos a mandar un correo a mi cuenta de gmail (para que funcione, el relay debe estar configurado para aceptar correo desde nuestra red):</p>
<p><img src="/images/ejercicios_servidor_correos/img_7.png" alt="img_7.png"></p>
<p>Veamos el log de postfix (<code>/var/log/mail.log</code>) para ver si se ha mandado:</p>
<p><img src="/images/ejercicios_servidor_correos/img_8.png" alt="img_8.png"></p>
<p>Como vemos, el log nos indica que se ha enviado. Comprobemos ahora si lo hemos recibido en nuestro cliente:</p>
<p><img src="/images/ejercicios_servidor_correos/img_9.png" alt="img_9.png"></p>
<p>Lo hemos recibido de forma satisfactoria. Miremos las cabeceras del correo y comprobemos los saltos que ha dado hasta llegar a mi cliente:</p>
<p><img src="/images/ejercicios_servidor_correos/img_10.png" alt="img_10.png"></p>
<p>En las cabeceras se nos indica que ha pasado tanto por apolo como por babuino, por lo que podemos concluir que este ejercicio ha sido un éxito.</p>
<h2 id="ejercicio-3-recibir-correos-desde-internet-a-usuarios-del-servidor">
  Ejercicio 3: Recibir correos desde Internet a usuarios del servidor
  <a class="heading-link" href="#ejercicio-3-recibir-correos-desde-internet-a-usuarios-del-servidor">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>En este ejercicio debes responder desde tu cuenta de correo personal al correo que recibiste en el ejercicio anterior. Recuerda que para que todo funcione debes indicarle al profesor el nombre de tu dominio para que configure de manera adecuada el parámetro relay_domains en babuino-smtp. Además debes configurar de manera adecuada el registro MX de tu servidor DNS.</p>
<p>Muestra el log del sistema donde se comprueba que el correo se ha recibido con éxito.</p>
<hr>
<p>Para empezar, debemos añadir a nuestro servidor dns un registro MX que indique a que máquina enviar el correo de nuestro dominio. Debido a que en Apolo tengo creada tres zonas (una para cada red), añadiríamos el registro MX a la zona externa, indicando que los correos que lleguen a nuestro dominio sean enviados a la máquina Zeus. En dicha máquina crearemos una regla DNAT, para que todos los correos sean transferidos a Apolo. Así pues, empecemos por el registro MX:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">nano /var/cache/bind/db.externa.dparrales.gonzalonazareno.org

$TTL    86400
@   IN  SOA zeus.dparrales.gonzalonazareno.org. dparrales.example.org. (
                  1     ; Serial
             604800     ; Refresh
              86400     ; Retry
            2419200     ; Expire
              86400 )   ; Negative Cache TTL
;
@       IN       NS     zeus.dparrales.gonzalonazareno.org.
@       IN       MX     10 zeus.dparrales.gonzalonazareno.org.

$ORIGIN dparrales.gonzalonazareno.org.

zeus    IN      A       172.22.9.170
www     IN      CNAME   zeus
python  IN      CNAME   zeus
</code></pre></div><p>Y reiniciamos el servicio:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">systemctl restart bind9
</code></pre></div><p>Ahora, en Zeus, vamos a crear la regla DNAT necesaria para transferir los correos que le lleguen a apolo. Para hacerla persistente, la añadimos al fichero <code>/etc/network/interfaces</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">post-up iptables -t nat -A PREROUTING -p tcp -i enp0s8 --dport 25 -j DNAT --to 10.0.1.102
</code></pre></div><p>Como estamos en una red interna dentro del instituto, debemos asegurarnos de que la puerta de enlace del mismo esté bien configurada y aceptando paquetes del puerto 25. Una vez confirmado esto, podemos ir a nuestro cliente de correos que usamos en el ejercicio anterior y responder al correo que nos llegó desde apolo:</p>
<p><img src="/images/ejercicios_servidor_correos/img_11.png" alt="img_11.png"></p>
<p>Al cabo de unos segundos, y si todo ha ido bien, nos aparece en el log de apolo que le ha llegado un correo:</p>
<p><img src="/images/ejercicios_servidor_correos/img_12.png" alt="img_12.png"></p>
<p>Veamos el correo usando la utilidad <code>mail</code>:</p>
<p><img src="/images/ejercicios_servidor_correos/img_13.png" alt="img_13.png"></p>
<p>Como vemos, el correo ha llegado correctamente, incluyendo todas las respuestas que estaban en cola por anteriores pruebas.</p>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
        <p>Para más entradas interesantes vean el blog de [Lara](https://sysraider.es)</p>
      
      
        ©
        
          2021 -
        
        2022
         Daniel Parrales 
      
      
         · 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>


    </main>

    
      
      <script src="/js/coder.min.a350362441276ec5c1671926420497bb8e52b63ead1d51d3c9bc4342d0039526.js" integrity="sha256-o1A2JEEnbsXBZxkmQgSXu45Stj6tHVHTybxDQtADlSY="></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
